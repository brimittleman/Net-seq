---
title: "Initial Data Exploration Netseq1"
author: "Brina Mittleman"
date: 2017-11-06
output: html_document
---

<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
```{r read-chunk, include=FALSE, cache=FALSE}
knitr::read_chunk("chunks.R")
```

<!-- Update knitr chunk options -->
```{r knitr-opts-chunk, include=FALSE}
```

<!-- Insert the date the file was last updated -->
```{r last-updated, echo=FALSE, results='asis'}
```

<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
```{r code-version, echo=FALSE, results='asis'}
```

<!-- Add your analysis here -->

I will use this analysis to look at inital data QC and points of interests.  

First I looked at the number of reads that mapp to the genome before and after deduplication UMI steps.  

`samtools view -c -F 4`  

For flag info: https://broadinstitute.github.io/picard/explain-flags.html  


Mayer data:
fastq: 137281933  
sorted: 120124203
dedup: 2262387  
dedup/sorted: 0.01883373  



```{r}
library= c( "18486-dep", "18486-tot", "18508-dep", "18508-nondep", "19238-dep", "mayer")

fastq= c( 45803834, 4006, 70776230, 77223987, 113160855, 137281933)  

sorted= c(17336796, 1258, 43247747, 50189574, 40420633, 17157730 )

dedup= c(1533069, 1105, 1776330,1919904,
1870359,2262387)

perc= dedup/sorted

reads_mapped_dedup= data.frame(rbind(library, fastq, sorted, dedup, perc))

reads_mapped_dedup

total_reads= sum(fastq)

sorted/fastq
```



Undetermined is nothing: it corresponds to random reads  

From meeting:  

* Allign with star and bwa to compare  

* compare to http://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&lastVirtModeType=default&lastVirtModeExtraState=&virtModeType=default&virtMode=0&nonVirtPosition=&position=chr7%3A5568588%2D5568715&hgsid=642260271_FLEwDANY0lSWCFhW4QjbmbASDDnB  

### Explore different mappers

```{bash, eval=FALSE}

#index and prepare ref genome:

STAR --runThreadN 2 --runMode genomeGenerate --genomeDir /scratch/midway2/brimittleman/star_genome/ --genomeFastaFiles  /project2/gilad/briana/Net-seq/STAR_genome/hg19.fa  --sjdbGTFfile /project2/gilad/briana/Net-seq/Homo_sapiens.GRCh37.75.chr.gtf --sjdbOverhang 43

# --sjdbOverhang read length -1 


STAR --runThreadN 4 --genomeDir /scratch/midway2/brimittleman/star_genome/ --readFilesIn fastq_extr/SRR1575922_extracted.fastq --outFilterMultimapNmax 1 --outSAMtype BAM SortedByCoordinate --outStd BAM_SortedByCoordinate > star/mayer_star_align.bam
```

```{bash, eval=FALSE}
samtools sort -o star.sort/star_mayer.sort.bam star/mayer_star_align.bam

```




Run this on my data as well. 


```{bash, eval=FALSE}
#!/bin/bash

#SBATCH --job-name=star_align_mayer
#SBATCH --time=8:00:00
#SBATCH --partition=broadwl
#SBATCH --mem=50G
#SBATCH --tasks-per-node=4 


module load Anaconda3
source activate net-seq

STAR --runThreadN 4 --genomeDir /scratch/midway2/brimittleman/star_genome/ --readFilesIn fastq_extr/YG-SP-NET1-18486-dep-2017-10-13_S4_R1_001_extracted.fastq  --outFilterMultimapNmax 1 --outSAMtype BAM SortedByCoordinate --outStd BAM_SortedByCoordinate > star/star_18486-dep.bam

#to run: sbatch --partition=broadwl --mem=50G
```

Continue with the sort and index the bam.  

```{bash, eval=FALSE}
samtools sort -o star.sort/star_18486_dep_sort.bam  star/star_18486-dep.bam
samtools index star_18486_dep_sort.bam
```

Look at the percent mapped with star.  
```{r}
samples=c("18486_dep", "mayer")
fastq_star= c(45803834,137281933)
bam_star= c(1996777,1993674)
bam_star/fastq_star
```

Thats way too low. This didnt work.  

In the log.Final file.  

% of reads unmapped: too many mismatches | 0.00%  
% of reads unmapped: too short | 79.96%  
% of reads unmapped: other | 0.00%

"--outFilterScoreMinOverLread 0 --outFilterMatchNminOverLread 0 --outFilterMatchNmin 0"
Try to add these parameters on the mayer map.  

This run gave too many multi-map reads. 64.82%. 

Try:  
"--outFilterScoreMinOverLread 0.3 --outFilterMatchNminOverLread 0.3"  
% of reads mapped to too many loci |	63.75%  


Test length of fastq reads:  
Mayer: total 137281933 avg=70.000000 stddev=0.000000
18486_dep: total 45803834 avg=44.000000 stddev=0.000000

Try clipping last 10 bases with : "--clip3pNbases 10"  
* This didnt work for the mayer data but that is long. I will try it on ours.  

Our data:  

* % of reads mapped to too many loci |	31.70%   
* % of reads unmapped: too short |	55.32%  

Other ways to fix this:  

* try blasting the unmapped reads 


###Look into BWA mapping  

BWA-backtrack - for Illumina seqs up to 100 bp  

First step is to construt a FM-index for the reference genome.  

"bwa index -a bwtsw  -p /scratch/midway2/brimittleman/BWA_genome/BWA.index STAR_genome/hg19.fa"

Added bwa to envirnoment  


Mapping:  

bwa aln  

* creates the .sai index files   

* -n 0.01 1% missmatch allowed  

* -t 2 spead up by using 2 threads 


bwa samse  

* generates alignments in a sam format  


```{bash eval=FALSE}

#$1 ref fa  
#$2 fastq 
#$3 output sai 


module load Anaconda3
source activate net-seq
module load bwa

bwa aln -t 3 -n 0.01 $1 $2 > $3


#submit 
sbatch scripts/bwa_aln.sh hg19.copy.fa /project2/gilad/briana/Net-seq/Net-seq1/data/fastq_extr/YG-SP-NET1-18486-dep-2017-10-13_S4_R1_001_extracted.fastq /project2/gilad/briana/Net-seq/Net-seq1/data/BWA/bwa.18486.dep.sai
```


```{bash eval=FALSE}


#SBATCH --job-name=BWA_samse
#SBATCH --time=8:00:00
#SBATCH --partition=broadwl
#SBATCH --mem=50G
#SBATCH --tasks-per-node=4
#SBATCH --mail-type=END

#$1 ref fasta
#$2 sai file  
#$3 fastq file  
#$4 output sam  


module load Anaconda3
source activate net-seq
module load bwa

bwa samse $1 $2 $3 > $4


#run on mayer  
sbatch hg19.copy.fa /project2/gilad/briana/Net-seq/data/bwa/bwa.mayer.sai /project2/gilad/briana/Net-seq/data/fastq_extrSRR1575922_extracted.fastq > /project2/gilad/briana/Net-seq/data/bwa/bwa.mayer.sam


#run on 18486 dep  
sbatch hg19.copy.fa /project2/gilad/briana/Net-seq/Net-seq1/data/BWA/bwa.18486.dep.sai /project2/gilad/briana/Net-seq/Net-seq1/data/fastq_extr/YG-SP-NET1-18486-dep-2017-10-13_S4_R1_001_extracted.fastq > /project2/gilad/briana/Net-seq/Net-seq1/data/BWA/bwa.18486.dep.sam


```

## Session information

<!-- Insert the session information into the document -->
```{r session-info}
```
